<!DOCTYPE html>
<head>
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/stylesheets/main.css">
  <script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.4/mapbox.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.4/mapbox.css' rel='stylesheet' />
  <style>
  body { margin:0; padding:0; }
  #map { height: 500px; width:50%; margin: 10px;}
</style>
</head>
  <body>
    <div id="header">
      <h1>WHUTZOPEN? SHOW PAGE</h1>
    </div>

    <div id="nav"> 
    <% if (currentUser) {%>
      <div>
        <h3>Welcome Back, </h3><%= currentUser.firstName %>
        <form method="get" action="/logout">   
          <button type="submit">LOG OUT</button>
        </form><br>
        <form method="get" action="/list">
          <button type="submit">SEARCH</button><br>
        </form> 
      </div>
    <%} else { %> 
        <form method="get" action="/sign_up">
          <button type="submit" id="sign_up">SIGN UP HERE</button>
        </form>
    <% } %>
    </div>  
    

    <div id='map'></div>
    <script id="venuesList" type="application/json"><%- JSON.stringify(venuesList) %></script>
    <script>
        var setupMap = function (map, coords){
        map.setView(coords, 13);
    // L.marker is a low-level marker constructor in Leaflet.

        // iterate over items in venues
        venuesList.forEach(function (item) {
          var loc = [
                      item.venue.location.lat,
                      item.venue.location.lng
                    ];

          //create a marker for each venue loc
          L.marker(loc, {
            // style icon
            icon: L.mapbox.marker.icon({
              'marker-size': 'large',
              'marker-symbol': 'star',
              'marker-color': '#1a4'
            })// adds to the map
          }).addTo(map);
        });

            
        // L.marker([37.9, -77], {
        //       icon: L.mapbox.marker.icon({
        //           'marker-size': 'large',
        //           'marker-symbol': 'bus',
        //           'marker-color': '#fa0'
        //       })
        //   }).addTo(map);
        };
        // window.addEventListener("load", function () {
          console.log("Hello world");
          var data = document.getElementById("venuesList");
          var venuesList =JSON.parse(data.innerHTML);
          console.log(venuesList);
          L.mapbox.accessToken = 'pk.eyJ1IjoiYW5kcmV3ZHBvaGwiLCJhIjoia0g2VFNjWSJ9.dvDZXc0gCmUkqD916mkNdQ';
          var map = L.mapbox.map('map', 'andrewdpohl.kfnbcn30')
          navigator.geolocation.getCurrentPosition(function (pos){
            console.log(pos)
            setupMap(map, [pos.coords.latitude, pos.coords.longitude]);
          }, function  (){
           var coords = [37.7833, 122.4167];
            setupMap(map, coords);
          })

        // });
      </script>

      <% venuesList.forEach(function (item) {  %>
        <div>
        <%= item.venue.name %><br>
        <%= item.venue.location.formattedAddress %><br>
        <a href= "<%= item.venue.url %>"><%= item.venue.url %></a><br>
        <%= item.venue.contact.formattedPhone %><br>
        <form action="/favorite" method="POST">
        <input name="favorite[venueId]" value="<%=item.venue.id%>"/>
        <input name="favorite[userId]" value="<%=currentUser.id%>"/>
          <button id="favorite">FAVORITE</button>
          </form>
        </div>

      <% }) %>
    </div>

    

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
  </body>
</html>